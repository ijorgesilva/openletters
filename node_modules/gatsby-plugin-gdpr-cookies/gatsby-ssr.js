"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _taggedTemplateLiteralLoose2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteralLoose"));

var _react = _interopRequireDefault(require("react"));

var _commonTags = require("common-tags");

var _merge = _interopRequireDefault(require("lodash/merge"));

var _validTrackingId = require("./valid-tracking-id");

var _defaultOptions = _interopRequireDefault(require("./default-options"));

function _templateObject6() {
  var data = (0, _taggedTemplateLiteralLoose2.default)(["\n            ", "\n            ", "\n          "]);

  _templateObject6 = function _templateObject6() {
    return data;
  };

  return data;
}

function _templateObject5() {
  var data = (0, _taggedTemplateLiteralLoose2.default)(["\n        &gtm_auth=", "&gtm_preview=", "&gtm_cookies_win=x\n      "]);

  _templateObject5 = function _templateObject5() {
    return data;
  };

  return data;
}

function _templateObject4() {
  var data = (0, _taggedTemplateLiteralLoose2.default)(["\n            !function(f,b,e,v,n,t,s)\n            {if(f.fbq)return;n=f.fbq=function(){n.callMethod?\n            n.callMethod.apply(n,arguments):n.queue.push(arguments)};\n            if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';\n            n.queue=[];t=b.createElement(e);t.async=!0;\n            t.src=v;s=b.getElementsByTagName(e)[0];\n            s.parentNode.insertBefore(t,s)}(window, document,'script',\n            'https://connect.facebook.net/en_US/fbevents.js');\n          "]);

  _templateObject4 = function _templateObject4() {
    return data;
  };

  return data;
}

function _templateObject3() {
  var data = (0, _taggedTemplateLiteralLoose2.default)(["", ""]);

  _templateObject3 = function _templateObject3() {
    return data;
  };

  return data;
}

function _templateObject2() {
  var data = (0, _taggedTemplateLiteralLoose2.default)(["<iframe src=\"https://www.googletagmanager.com/ns.html?id=", "", "\" height=\"0\" width=\"0\" style=\"display: none; visibility: hidden\"></iframe>"]);

  _templateObject2 = function _templateObject2() {
    return data;
  };

  return data;
}

function _templateObject() {
  var data = (0, _taggedTemplateLiteralLoose2.default)(["\n  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':\n  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],\n  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=\n  'https://www.googletagmanager.com/gtm.js?id='+i+dl+'", "';f.parentNode.insertBefore(j,f);\n  })(window,document,'script','", "', '", "');"]);

  _templateObject = function _templateObject() {
    return data;
  };

  return data;
}

var generateGTM = function generateGTM(id, dataLayerName, environmentParamStr) {
  return (0, _commonTags.stripIndent)(_templateObject(), environmentParamStr, dataLayerName, id);
};

var generateGTMIframe = function generateGTMIframe(id, environmentParamStr) {
  return (0, _commonTags.oneLine)(_templateObject2(), id, environmentParamStr);
};

var generateGTMDefaultDataLayer = function generateGTMDefaultDataLayer(dataLayer, dataLayerName, reporter) {
  var result = "window." + dataLayerName + " = window." + dataLayerName + " || [];";

  if (dataLayer.type === "function") {
    result += "window." + dataLayerName + ".push((" + dataLayer.value + ")());";
  } else {
    if (dataLayer.type !== "object" || dataLayer.value.constructor !== Object) {
      reporter.panic("Oops the plugin option \"defaultDataLayer\" should be a plain object. \"" + dataLayer + "\" is not valid.");
    }

    result += "window." + dataLayerName + ".push(" + JSON.stringify(dataLayer.value) + ");";
  }

  return (0, _commonTags.stripIndent)(_templateObject3(), result);
}; // add scripts


exports.onRenderBody = function (_ref, pluginOptions) {
  var setHeadComponents = _ref.setHeadComponents,
      setPreBodyComponents = _ref.setPreBodyComponents,
      reporter = _ref.reporter;

  if (pluginOptions === void 0) {
    pluginOptions = {};
  }

  var currentEnvironment = process.env.ENV || process.env.NODE_ENV || "development";
  var options = (0, _merge.default)(_defaultOptions.default, pluginOptions);
  var headComponents = [];
  var preBodyComponents = []; // facebook pixel

  if (options.environments.includes(currentEnvironment) && (0, _validTrackingId.validFbPixelId)(options)) {
    headComponents.push(_react.default.createElement("script", {
      key: "gatsby-plugin-gdpr-cookies-google-analytics",
      dangerouslySetInnerHTML: {
        __html: (0, _commonTags.stripIndent)(_templateObject4())
      }
    }));
  } // google tag manager


  if (options.environments.includes(currentEnvironment) && (0, _validTrackingId.validGTMTrackingId)(options)) {
    var googleTagManager = options.googleTagManager;
    var environmentParamStr = "";

    if (googleTagManager.gtmAuth && googleTagManager.gtmPreview) {
      environmentParamStr = (0, _commonTags.oneLine)(_templateObject5(), googleTagManager.gtmAuth, googleTagManager.gtmPreview);
    }

    var defaultDataLayerCode = "";

    if (googleTagManager.defaultDataLayer) {
      defaultDataLayerCode = generateGTMDefaultDataLayer(googleTagManager.defaultDataLayer, googleTagManager.dataLayerName, reporter);
    }

    headComponents.push(_react.default.createElement("script", {
      key: "gatsby-plugin-gdpr-cookies-google-tagmanager",
      dangerouslySetInnerHTML: {
        __html: (0, _commonTags.oneLine)(_templateObject6(), defaultDataLayerCode, generateGTM(googleTagManager.trackingId, googleTagManager.dataLayerName, environmentParamStr))
      }
    }));
    preBodyComponents.push(_react.default.createElement("noscript", {
      key: "gatsby-plugin-gdpr-cookies-google-tagmanager",
      dangerouslySetInnerHTML: {
        __html: generateGTMIframe(googleTagManager.trackingId, environmentParamStr)
      }
    }));
  } // add scripts


  if (headComponents.length) {
    setHeadComponents(headComponents);
  }

  if (preBodyComponents.length) {
    setPreBodyComponents(preBodyComponents);
  }
};